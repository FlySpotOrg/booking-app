name: Smoke Test Run

on:
  push:
  workflow_dispatch:

jobs:
  trigger-smoke:
    name: Trigger Smoke Suite in playwrightDemoProject
    runs-on: ubuntu-latest

    steps:
      - name: Trigger smoke test in playwrightDemoProject repo
        id: trigger
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.REPO_A_PAT }}
          repository: FlySpotOrg/playwrightDemoProject
          event-type: run-smoke-tests-from-app-repo
          client-payload: '{"test_scope": "smoke", "run_branch": "${{ github.ref_name }}"}'

      - name: Wait for Playwright Tests to Complete
        id: wait_for_run
        env:
          GH_TOKEN: ${{ secrets.REPO_A_PAT }}
        run: |
          echo "Waiting for triggered workflow run to complete..."

          for i in {1..40}; do
            RUN_INFO=$(gh api repos/FlySpotOrg/playwrightDemoProject/actions/runs \
              --paginate -q '.workflow_runs[] | select(.event=="repository_dispatch" and .name=="Playwright Test Runner")' | \
              jq 'sort_by(.created_at) | reverse | .[0]')

            if [ -z "$RUN_INFO" ]; then
              echo "Workflow run not found yet. Waiting..."
              sleep 10
              continue
            fi

            RUN_ID=$(echo "$RUN_INFO" | jq -r '.id')
            STATUS=$(echo "$RUN_INFO" | jq -r '.status')
            CONCLUSION=$(echo "$RUN_INFO" | jq -r '.conclusion')

            echo "Run ID: $RUN_ID"
            echo "Status: $STATUS"
            echo "Conclusion: $CONCLUSION"

            if [[ "$STATUS" == "completed" ]]; then
              echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
              if [[ "$CONCLUSION" == "success" ]]; then
                echo "Run completed successfully."
                break
              else
                echo "Run completed with conclusion: $CONCLUSION"
                exit 1
              fi
            fi

            echo "Still running... Waiting 10s"
            sleep 10
          done

      - name: Output Report Link
        run: |
          echo "### âœ… Allure Report: https://flyspotorg.github.io/playwrightDemoProject/smoke/${{ env.RUN_ID }}/" >> $GITHUB_STEP_SUMMARY      
  
  
  # smoke-tests:
  #   name: Smoke Suite
  #   uses: FlySpotOrg/playwrightDemoProject/.github/workflows/playwright-test-run.yml@main
  #   with:
  #     run_branch: ${{ github.event.pull_request.head.ref || github.ref_name }}
  #     test_scope: smoke
  #   secrets:
  #     ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
  #     ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
  #     WORKFLOW_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #     REPO_A_PAT: ${{ secrets.REPO_A_PAT }}
